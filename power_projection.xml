<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, March 10, 2018, 10:56 PM -->
<!-- MuClient version 5.06-pre -->

<!-- Plugin "power_projection" generated by Plugin Wizard -->

<muclient>
<plugin
   name="power_projection"
   author="Daak"
   id="2aa18e928a8dfef20a6a0703"
   language="Lua"
   purpose="Power Project miniwindow"
   save_state="y"
   date_written="2018-03-10 22:55:50"
   requires="5.06"
   version="1.0"
   >
<description trim="y">
<![CDATA[
Keeps track of Power Project status in a miniwindow.

  pp check         - Forces the re-check of power project status
  pp ready         - Sets power projection to ready
  pp active        - Sets power projection to active
  pp limp          - Sets power projection recovery
  pp help          - Your looking at it

NOTE: Aliases are only to set states, plugins automatically switches state based on power projection triggers.
PS: The function names are pp, yes this is pee pee. Hah! All finished?
]]>
</description>
</plugin>

<!--  Get our standard constants -->
<include name="constants.lua"/>

<aliases>
  <alias
   script="pp_ready"
   match="^pp ready$"
   enabled="y" regexp="y" sequence="100" ignore_case="y"
  >
  </alias>
  <alias
   script="pp_active"
   match="^pp active$"
   enabled="y" regexp="y" sequence="100" ignore_case="y"
  >
  </alias>
  <alias
   script="pp_limp"
   match="^pp limp$"
   enabled="y" regexp="y" sequence="100" ignore_case="y"
  >
  </alias>
  <alias
   script="pp_check"
   match="^pp check$"
   enabled="y" regexp="y" sequence="100" ignore_case="y"
  >
  </alias>
  <alias
   script="OnHelp"
   match="^pp help$"
   enabled="y" regexp="y" sequence="100" ignore_case="y"
  >
  </alias>
</aliases>

<triggers>
  <trigger
   enabled="y"
   match="^## You may now use projection abilities.$"
   name="pp_ready"
   script="pp_ready"
   sequence="100"
   regexp="y"
   group="pp_group"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   enabled="y"
   match="^Your pulse races as magical forces build within you.$"
   name="pp_active"
   script="pp_active"
   sequence="100"
   regexp="y"
   group="pp_group"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   enabled="y"
   match="^You feel your power projection fade.$"
   name="pp_limp"
   script="pp_limp"
   sequence="100"
   regexp="y"
   group="pp_group"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   enabled="n"
   match="^  Power projection         : enhanced magic attacks \([0-9:]+\)$"
   name="pp_check_enabled"
   script="pp_check_enabled"
   sequence="100"
   regexp="y"
   group="pp_check_group"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   enabled="n"
   match="^  Projection               : [0-9:]+$"
   name="pp_check_recovery"
   script="pp_check_recovery"
   sequence="100"
   regexp="y"
   group="pp_check_group"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   enabled="n"
   match="^Use 'saffects' to see a short version of your affects\.$"
   name="pp_check_end"
   script="pp_check_end"
   sequence="100"
   regexp="y"
   group="pp_check_group"
   omit_from_output="n"
  >
  </trigger>
</triggers>

<script>
<![CDATA[

require "tprint"
require "movewindow"

window_init = false
win = "win" .. GetPluginID ()

havePP = false
havePPRecovery = false

function window_create(color)
  if window_init == false then
    WindowCreate (win, 0, 0, 70, 70, miniwin.pos_center_all, 0, ColourNameToRGB("black"))
    WindowShow (win, true)
  end
  WindowArc (win, 10, 10, 60, 60, 18, 10, 53, 10, ColourNameToRGB (color), miniwin.pen_solid, 4)
  WindowLine (win, 35, 3, 35, 28, ColourNameToRGB (color), miniwin.pen_solid, 4)
  --- install the window movement handler, get back the window position.
  movewindow.add_drag_handler (win, 0, 0, 70, 70, miniwin.cursor_both_arrow)
  window_init = true
end -- window_create

window_create("cyan")

function window_delete()
  WindowDelete(win)
end -- window_delete

function OnPluginInstall ()
   windowinfo = movewindow.install (win, miniwin.pos_top_right, miniwin.create_absolute_location, false, nil, {mouseup=MouseUp, mousedown=LeftClickOnly, dragmove=LeftClickOnly, dragrelease=LeftClickOnly},{x=default_x, y=default_y})
end

function OnPluginSaveState ()
   -- save window current location for next time
   movewindow.save_state (win)
end

function OnPluginDisable ()
  window_delete()
end -- function

function pp_active()
  window_create("red")
end -- pp_active

function pp_ready()
  window_create("yellow")
end -- pp_ready

function pp_limp()
  window_create("slategray")
end -- pp_limp

function pp_check()
  EnableTriggerGroup("pp_check_group", true)
  havePP = false
  havePPRecovery = false
  Send("aff project")
end -- pp_check

pp_check()

function pp_check_enabled()
  havePP = true
end -- pp_check_enabled

function pp_check_recovery()
  havePPRecovery = true
end -- pp_check_recovery

function pp_check_end()
  EnableTriggerGroup("pp_check_group", false)
  if havePP then
    pp_active()
    return
  end
  if havePPRecovery then
    pp_limp()
    return
  end
  pp_ready()
end -- pp_check_end

-- Window Stuff --

-- Utils  --

function tableCountItems(ttable)
  local count = 0
  for i,v in pairs(ttable) do
    count = count + 1
  end
  if count == 0 then
    for i,v in ipairs(ttable) do
      count = count + 1
    end
  end
  return count
end

function padRight(text, length, padChar)
  local padding = length - string.len(text)
  for i = 1, padding do
    text = text .. padChar
  end
  return text
end

function trim(s)
  return s:match "^%s*(.-)%s*$"
end

function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end

]]>
</script> 
</muclient>
