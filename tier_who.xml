<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Tuesday, February 27, 2018, 9:37 AM -->
<!-- MuClient version 5.06-pre -->

<!-- Plugin "tier_who" generated by Plugin Wizard -->

<muclient>
<plugin
   name="tier_who"
   author="Daak"
   id="697fc449aa65f5303c04ab10"
   language="Lua"
   purpose="Uses swho to replace Level with L#T#R#"
   save_state="y"
   date_written="2018-02-27 09:36:12"
   requires="5.06"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<aliases>
  <alias
    match="^twho (?&lt;params&gt;.*)$"
    script="twho_start"
    name="twho_start"
    enabled="y" regexp="y" sequence="100" ignore_case="y"
    >
  </alias>
  <alias
    match="^twho$"
    script="twho_start"
    name="twho_start_no_params"
    enabled="y" regexp="y" sequence="100" ignore_case="y"
    >
  </alias>
</aliases>

<triggers>
  <trigger
   enabled="n"
   match="\[ *(?&lt;currlevel&gt;\d+) *(?&lt;race&gt;[\w-]+) *(?&lt;remort&gt;[\w\+]+)\] \[ *(?&lt;reallevel&gt;\d+) *\] (?&lt;person&gt;.*)"
   name="twho_person"
   script="twho_person"
   sequence="100"
   regexp="y"
   group="twho_group"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   match="^\[ *(?&lt;herotitle&gt;.*) *\] \[ *(?&lt;reallevel&gt;\d+) *\] (?&lt;person&gt;.*)$"
   name="twho_hero"
   script="twho_person"
   sequence="100"
   regexp="y"
   group="twho_group"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   match="^Players invis: \[\d+\], Max on ever: \[\d+\]$"
   name="twho_end"
   script="twho_end"
   sequence="100"
   regexp="y"
   group="twho_group"
   omit_from_output="n"
  >
  </trigger>
</triggers>

<script>
<![CDATA[

-- require "tprint"

function twho_start (name, line, wildcards)
  -- Note("twho_start fired")
  if wildcards.params == "help" then
    show_help()
    return
  end
  EnableTriggerGroup("twho_group", true)
  if name == "twho_start_no_params" then
    Send("swho 9")
  else
    Send("swho 9 " .. wildcards.params)
  end
end -- twho_start

function twho_person (name, line, wildcards, styles)
  local target_closes = 2
  if name == "twho_hero" then
    target_closes = 1
  end
  -- [  1  Triton W+7] [  42010 ] Tier1
  -- [ 14  Eldar  H+7] [  18104 ] (HARDCORE) Member [Clan]
  -- [112  Wolf   P+2] [  22825 ] (OPK) Freekill [C]
  -- [   __________  ] [  43416 ] Superhero
  -- tprint(styles)
  -- tprint(wildcards)
  local bracket_closes = 0
  local sent_output = 0
  local output = ""
  local output_redo = ""
  for i, s in ipairs(styles) do
    ColourTell(RGBColourToName(s.textcolour), "", s.text)
    if sent_output == 0 and s.text == "]" then
      bracket_closes = bracket_closes + 1
    end
    if sent_output == 0 and bracket_closes == target_closes then
      output = tier_output(wildcards.reallevel)
      ColourTell("yellow", "", " [ ")
      ColourTell("red", "", padRight(output, 8, " "))
      ColourTell("yellow", "", " ]")
      if tonumber(wildcards.reallevel) > (1407 * 10) then
        output_redo = redo_output(wildcards.reallevel)
        ColourTell("yellow", "", " [ ")
        ColourTell("red", "", padRight("REDO+" .. output_redo, 8, " "))
        ColourTell("yellow", "", " ]")
      end
      sent_output = 1
    end
  end
end -- twho_person

function twho_end (name, line, wildcards)
  -- Note("twho_end fired")
  EnableTriggerGroup("twho_group", false)
end -- twho_end

function tier_output (reallevel)
  local tiers = 0
  local remorts = 1
  local level = 0
  reallevel = tonumber(reallevel)
  level = reallevel % 201
  if level == 0 then
    level = 201
  end
  if reallevel > 1407 then
    tiers = math.floor(reallevel / 1407)
  end
  remorts = math.ceil((reallevel - tiers * 1407) / 201)
  if remorts == 0 then
    remorts = 7
  end
  if tiers > 9 then
    tiers = 9
  end
  return "T" .. tiers .. "R" .. remorts .. "L" .. level
end --tier_output

-- TODO combine with tier_output
function redo_output (reallevel)
  reallevel = tonumber(reallevel)
  local redos = 0
  if reallevel > 1407 then
    tiers = math.floor(reallevel / 1407)
  end
  return tiers - 9
end --tier_output

function show_help ()
  Note("Help for Daak's tier who:\n")
  Tell(padRight("  twho <params>", 12, " "))
  Note(": For valid params, see: help who")
  Tell(padRight("  twho help", 12, " "))
  Note(": You're looking at it\n")
end -- show_help

-- Utils  --

function tableCountItems(ttable)
  local count = 0
  for i,v in pairs(ttable) do
    count = count + 1
  end
  if count == 0 then
    for i,v in ipairs(ttable) do
      count = count + 1
    end
  end
  return count
end

function padRight(text, length, padChar)
  local padding = length - string.len(text)
  for i = 1, padding do
    text = text .. padChar
  end
  return text
end

function trim(s)
  return s:match "^%s*(.-)%s*$"
end

]]>
</script> 

</muclient>
